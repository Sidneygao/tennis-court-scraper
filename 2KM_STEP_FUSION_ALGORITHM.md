# 2KM类别步进融合价格预测算法

## 算法概述
基于场馆地理位置的智能价格预测算法，通过抓取周边同类型场馆的真实价格数据，进行加权平均计算得出预测价格。

## 核心原理
1. **地理位置驱动**：以目标场馆的经纬度坐标为基础
2. **半径扩展策略**：从2KM开始，逐步向外扩展1KM
3. **同类型匹配**：只抓取同类型场馆的真实价格数据
4. **数据充足性**：确保有效数据≥3家才进行计算

## 算法流程

### 1. 数据筛选
- **目标场馆**：主表和详情表都没有真实价格缓存的场馆
- **真实价格字段**：`dianping_prices`、`meituan_prices`、`merged_prices`
- **预测价格字段**：`predict_prices`（与真实价格分离存储）

### 2. 地理范围计算
```
初始半径 = 2KM
扩展步长 = 1KM
最小有效数据量 = 3家
```

### 3. 价格抓取策略
对每个目标场馆：
1. 以场馆经纬度为中心，2KM为半径搜索同类型场馆
2. 抓取这些场馆的真实价格数据（黄金价格 + 非黄金价格）
3. 如果有效数据 < 3家，半径 +1KM，重复步骤2
4. 直到满足 ≥3家有效数据或达到最大搜索半径

### 4. 价格计算
```
黄金价格预测 = 取整(有效场馆黄金价格平均值, 10)
非黄金价格预测 = 取整(有效场馆非黄金价格平均值, 10)
```

### 5. 数据存储
- **字段**：`predict_prices`
- **格式**：JSON格式存储预测结果
- **防覆盖**：已有预测数据不重复计算

## 数据结构

### 输入数据
```python
{
    "court_id": 123,
    "name": "场馆名称",
    "latitude": 39.9042,
    "longitude": 116.4074,
    "court_type": "室内网球场"
}
```

### 输出数据
```python
{
    "predict_prices": {
        "peak_price": 120,      # 黄金价格（取整到10）
        "off_peak_price": 90,   # 非黄金价格（取整到10）
        "data_count": 5,        # 有效数据场馆数量
        "search_radius": 3,     # 最终搜索半径（KM）
        "predict_time": "2025-06-27T15:00:00",
        "source_courts": [      # 参考场馆列表
            {"id": 456, "name": "参考场馆1", "distance": 1.2},
            {"id": 789, "name": "参考场馆2", "distance": 1.8}
        ]
    }
}
```

## 算法特点

### 优势
1. **地理位置精确**：基于真实经纬度，避免区域概念模糊
2. **数据驱动**：完全基于真实价格数据，无人工设定基准
3. **自适应扩展**：根据数据充足性自动调整搜索范围
4. **类型匹配**：确保参考场馆类型一致，提高预测准确性
5. **防重复计算**：已有预测数据不覆盖，保证数据稳定性

### 适用场景
- 新开业场馆价格预测
- 价格信息缺失场馆补全
- 价格合理性验证
- 市场竞争分析

## 实现要求

### 技术栈
- Python 3.8+
- SQLAlchemy（数据库操作）
- 地理距离计算库
- JSON数据处理

### 性能考虑
- 批量处理：支持批量预测多个场馆
- 并发控制：避免数据库连接冲突
- 缓存机制：避免重复计算
- 错误处理：单场馆失败不影响整体流程

## 版本记录
- v1.0 (2025-06-27): 初始算法设计
- 基于地理位置的真实数据融合预测
- 支持黄金/非黄金价格分别预测
- 实现2KM起步，1KM步进扩展策略 